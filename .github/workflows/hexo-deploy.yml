name: Hexo Auto Deploy (GitHub Only)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source + Submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.HEXO_DEPLOY_TOKEN }}

      - name: Check Submodules Status
        run: |
          echo "===== 子模块列表 ====="
          git submodule status
          echo "===== themes目录内容 ====="
          ls -la ./themes || echo "themes目录不存在"

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies (Hexo+Plugins)
        run: |
          echo "===== 当前工作目录 ====="
          pwd
          ls -la

          echo "===== npm版本 ====="
          npm -v

          echo "===== 安装项目依赖 ====="
          npm install

          echo "===== 检查node_modules目录 ====="
          ls -la node_modules/ | head -20

          echo "===== 检查hexo核心包 ====="
          ls -la node_modules/hexo/ || echo "❌ hexo目录不存在"

          echo "===== 已安装依赖列表 ====="
          npm list --depth=0

      - name: Install NexT Theme
        run: |
          echo "===== 下载NexT主题 ====="
          rm -rf themes/next themes/landscape
          git clone https://github.com/next-theme/hexo-theme-next.git themes/next --depth=1
          rm -rf themes/next/.git
          echo "===== 主题文件列表 ====="
          ls -la themes/next/

      - name: Build Hexo Static Files
        run: |
          echo "===== Hexo版本 ====="
          npm exec -- hexo version
          echo "===== 清理旧文件 ====="
          npm exec -- hexo clean
          echo "===== 生成静态文件（Debug模式） ====="
          npm exec -- hexo generate --debug
          echo "===== 验证public目录（核心！空则失败） ====="
          if [ ! -d ./public ] || [ -z "$(find ./public -mindepth 1 -maxdepth 1 -print -quit)" ]; then
            echo "❌ public目录不存在或为空！构建失败，终止部署"
            exit 1
          fi
          echo "✅ public目录有内容，文件列表："
          ls -la ./public
          echo "===== public目录关键文件（index.html） ====="
          head -20 ./public/index.html

      - name: Inject Mermaid Support
        run: |
          echo "===== 注入 Mermaid 支持 ====="
          # 创建 Mermaid 初始化脚本
          MERMAID_SCRIPT='<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("pre code.language-mermaid,pre code.mermaid").forEach(function(el){var div=document.createElement("div");div.className="mermaid";div.textContent=el.textContent;el.parentNode.replaceWith(div)});mermaid.initialize({startOnLoad:true,theme:"neutral",themeVariables:{background:"transparent"}});mermaid.run()});</script>'
          # 注入到所有 HTML 文件的 </body> 标签前
          find ./public -name "*.html" -exec sed -i "s|</body>|${MERMAID_SCRIPT}</body>|g" {} \;
          echo "✅ Mermaid 注入完成"

      - name: Deploy to riiiccck.github.io
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.HEXO_DEPLOY_TOKEN }}
          publish_dir: ./public
          external_repository: riiiccck/riiiccck.github.io
          publish_branch: main
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          force_orphan: true
          verbose: true

      - name: Verify Deployment
        run: |
          echo "===== 部署完成！目标仓库最新提交 ====="
          git clone https://${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/riiiccck/riiiccck.github.io.git temp-deploy
          ls -la temp-deploy
          rm -rf temp-deploy
