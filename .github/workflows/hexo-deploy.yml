name: Hexo Auto Deploy (GitHub Only)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source + Submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.HEXO_DEPLOY_TOKEN }}

      - name: Check Submodules Status
        run: |
          echo "===== 子模块列表 ====="
          git submodule status
          echo "===== themes目录内容 ====="
          ls -la ./themes || echo "themes目录不存在"

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Dependencies (Hexo+Plugins)
        run: |
          echo "===== npm版本 ====="
          npm -v

          # 清理可能导致403的代理配置（解决代理引发的访问拒绝问题）
          echo "===== 清理可能导致403的代理配置 ====="
          unset npm_config_proxy npm_config_https_proxy npm_config_http_proxy HTTP_PROXY HTTPS_PROXY http_proxy https_proxy
          npm config delete proxy || true  # 即使删除失败也不中断
          npm config delete https-proxy || true
          npm config delete http-proxy || true

          # 优先用npm ci安装（严格按lockfile，失败则回退npm install）
          echo "===== 安装项目依赖 ====="
          if ! npm ci --verbose; then
            echo "⚠️ npm ci失败（常见原因：lockfile严格校验），回退npm install"
            npm install --verbose
          fi

          # 若上述安装仍失败，尝试切换国内源重试npm ci
          if ! npm list --depth=0 >/dev/null 2>&1; then
            echo "⚠️ 默认源安装失败，尝试npmmirror源"
            if ! npm ci --verbose --registry=https://registry.npmmirror.com; then
              echo "⚠️ npmmirror安装失败，回退到官方npm源"
              npm ci --verbose --registry=https://registry.npmjs.org
            fi
          fi

          # 输出已安装的依赖列表（失败不中断）
          echo "===== 已安装依赖列表 ====="
          npm list --depth=0 || true


      - name: Build Hexo Static Files
        run: |
          echo "===== Hexo版本 ====="
          npx hexo -v
          echo "===== 清理旧文件 ====="
          npx hexo clean
          echo "===== 生成静态文件（Debug模式） ====="
          npx hexo generate --debug
          echo "===== 验证public目录（核心！空则失败） ====="
          if [ ! -d ./public ] || [ -z "$(find ./public -mindepth 1 -maxdepth 1 -print -quit)" ]; then
            echo "❌ public目录不存在或为空！构建失败，终止部署"
            exit 1
          fi
          echo "✅ public目录有内容，文件列表："
          ls -la ./public
          echo "===== public目录关键文件（index.html） ====="
          head -20 ./public/index.html

      - name: Deploy to riiiccck.github.io
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.HEXO_DEPLOY_TOKEN }}
          publish_dir: ./public
          external_repository: riiiccck/riiiccck.github.io
          publish_branch: main
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          force_orphan: true
          verbose: true

      - name: Verify Deployment
        run: |
          echo "===== 部署完成！目标仓库最新提交 ====="
          git clone https://${{ secrets.HEXO_DEPLOY_TOKEN }}@github.com/riiiccck/riiiccck.github.io.git temp-deploy
          ls -la temp-deploy
          rm -rf temp-deploy
